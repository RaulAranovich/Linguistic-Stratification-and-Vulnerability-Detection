<?xml version="1.0" encoding="utf-8"?>
<post><title>security - IE 11 first-party session cookies being lost in iframe - Stack Overflow</title><question><text><div class="post-text" itemprop="text">
<p>We have a site (www.example.com) which sends users off to a series of third party pages to verify payment details, which we do in an iframe. Initially, a local page from www.example.com is loaded in the iframe, and the user is redirected to the third party URL. Once the third party steps are completed by the user, they are 302 redirected back to a page on our site (www.example.com) within the iframe.</p>
<p>This works in all browsers we've tested except IE 11, where our cookies appear to be lost. We have checked this under both Windows 7 and 8.1, in both desktop and "Metro" modes, and the problem is across all versions.</p>
<p>When a user browses our site we set a session cookie, which is correctly sent to the first-party page that is initially loaded in the iframe. Once the user has gone through some third-party pages in this iframe however, the session cookie isn't sent with the next request.</p>
<p>If we set IE 11's privacy setting to the lowest value, this issue disappears and things work as expected.</p>
<p>All potential solutions I've turned up so far have related to P3P headers. We have a valid and correct P3P header and XML policy file set up, and this problem only occurs in IE 11.</p>
<hr/>
<p><strong>Update:</strong> We have a few other cookies set using JS. These are all persisting as expected. The differences are the expiry date (1 year for JS cookies, 1 month for session cookie), the domain (explicitly "example.com" for JS cookies, empty for session cookie) and whether they are "HTTP only" (false for JS cookies, true for session cookie).</p>
<p>I have tried setting all of these options as per the JS cookies for the session cookie, but it made no difference.</p>
<hr/>
<p><strong>Update 2:</strong> After more testing I have been unable to create a test case that recreates this problem. Any additional cookies I try testing with in the live code however also appear to be broken, even if they are set with exactly the same code as the JS cookies which work. In short; I've not yet found any pattern to the cookies which work and those which don't.</p>
<p>One potentially interesting thing to note is that the cookies aren't being deleted, they're just not being sent to the final request. If another page is loaded, the cookies magically reappear and are sent; which leads me to believe this is a bug surrounding iframes and P3P.</p>
<hr/>
<p><strong>Update 3 (day 3):</strong> IE 11's handling of cookies continues to confound me. The further I travel into Microsoft's labyrinth the more lost I become amongst its shifting walls. And there are ghosts in here. Fragments of half-dreamt security policies that have woven themselves into some ethereal creature, which tracks and taunts me at every move. At first I was frozen, terrified, aghast at the barely fathomable form darting just out of sight, but with every passing hour I gather more comfort from the mere knowledge of its proximity. Could this be the very beast I have been sent here to confront? How could I slay my only companion in such times?</p>
</div></text><author><a href="/users/3204551/deduplicator">Deduplicator</a></author><comments><comment><text><span class="comment-copy">Can you show the P3P header you are using?</span></text><author><a class="comment-user" href="/users/307976/vtortola" title="16,484 reputation">vtortola</a></author></comment><comment><text><span class="comment-copy"><code>P3P: CP="ALL DSP COR CUR ADM PSA CONi OUR SAM OTR UNR LEG"</code>  Without this header no cookies are working in the iframe, as expected. With it some cookies are working, but some, seemingly at random, are not. I've not been able to find a pattern or anything different about the ones which don't work.</span></text><author><a class="comment-user owner" href="/users/867633/jaik-dean" title="444 reputation">Jaik Dean</a></author></comment><comment><text><span class="comment-copy">Try <a href="http://stackoverflow.com/a/13975828/307976">stackoverflow.com/a/13975828/307976</a></span></text><author><a class="comment-user" href="/users/307976/vtortola" title="16,484 reputation">vtortola</a></author></comment><comment><text><span class="comment-copy">Nice poetry Shakespear!</span></text><author><a class="comment-user" href="/users/987864/daan" title="2,314 reputation">Daan</a></author></comment><comment><text><span class="comment-copy">Nice poetry indeed. Also, try external policy? <code>P3P: policyref="/w3c/p3p.xml", CP="IDC DSP COR IVAi IVDi OUR TST"</code></span></text><author><a class="comment-user" href="/users/2794106/furkan-omay" title="666 reputation">Furkan Omay</a></author></comment><comment><text><span class="comment-copy">See this: <a href="http://stackoverflow.com/a/16475093/457850">stackoverflow.com/a/16475093/457850</a> - I spent hours trying to get P3P and cookies playing nicely in an iframe. Put an invalid P3P header like <code>we do not have P3P</code> and it works just fine.</span></text><author><a class="comment-user" href="/users/457850/dtbaker" title="534 reputation">dtbaker</a></author></comment><comment><text><span class="comment-copy">Did you try this in Windows 10? IE 11 in W10 shall not use P3P header, if the problem is appearing here it might be easier to raise a support ticket at Microsoft.</span></text><author><a class="comment-user" href="/users/2294065/frode-nilsen" title="124 reputation">Frode Nilsen</a></author></comment><comment><text><span class="comment-copy">I didn't, I had the original issue a year before Windows 10's public release.</span></text><author><a class="comment-user owner" href="/users/867633/jaik-dean" title="444 reputation">Jaik Dean</a></author></comment></comments></question><answers><answer><text><div class="post-text" itemprop="text">
<p>We encountered a similar problem with Internet Explorer 11 where the session cookie went missing after a redirect over https.</p>
<p>The request chain looked something like this:</p>
<p><em>initial request to /</em> <strong>-&gt;</strong> <em>session cookie set</em> <strong>-&gt;</strong> <em>redirect to an external URL</em> <strong>-&gt;</strong> <em>redirect back</em> (session cookie lost)</p>
<p>Our problem was due to an invalid host name according to <a href="https://tools.ietf.org/html/rfc952" rel="nofollow">RFC952</a>, we had underscores in our test server URL. It seems that Internet Explorer silently drops the session cookie on redirect over https if the URL does not conform to RFC952. When using dashes instead of underscores, everything worked as expected.</p>
<p>The original solution was found in the <strong>Update 2</strong> section of this <a href="http://weblogs.asp.net/bleroy/Don_2700_t-redirect-after-setting-a-Session-variable-_2800_or-do-it-right_2900_" rel="nofollow">asp.net blogpost from 2004.</a> Related microsoft bug ticket <a href="https://connect.microsoft.com/IE/feedback/details/810700/subject-ie11-is-losing-cookie-information-and-thus-becoming-detached-from-a-web-application-session" rel="nofollow">here.</a> </p>
<p>Hopefully this will help someone.</p>
</div></text><author><a href="/users/1502563/oakninja">OakNinja</a></author><comments><comment><text><span class="comment-copy">Funny I found that problem in 2008 â€” underscores in domain names are not allowed, for this reason.</span></text><author><a class="comment-user" href="/users/3163663/jason-fb" title="843 reputation">Jason FB</a></author></comment></comments></answer><answer><text><div class="post-text" itemprop="text">
<p>I have noticed session cookies are often lost when IE7 compatibility mode is engaged for a new page.  I suppose the same could apply to the iframe. Is the iframe sending a X-UA-Compatible header value that is different than the parent page, or different than earlier in the session?  Like maybe your session started with IE=edge, and the iframe page sets it to IE=7.  If so, IE seems to spin up a new IE PID for the compatibility mode pages and session cookies often (but it seems don't get transferred.</p>
</div></text><author><a href="/users/6034775/ray-darrow">Ray Darrow</a></author><comments/></answer><answer><text><div class="post-text" itemprop="text">
<p>I have the same issue that is mentioned on this topic.</p>
<p>Our site is placed in an iframe and using session to cookie(asp.net_session). While navigation in site there is not problem (cookies are working and attached to the requests headers). But when we redirect customer to another website(othersite.com) then othersite.com redirect customer to our domain and force it to open as "_top", browser doesn't send the cookies with requests so that we lost the customers session. This problem only occured on IE.</p>
<p>What can you advice to fix this problem.</p>
</div></text><author><a href="/users/178524/yucel">Yucel</a></author><comments><comment><text><span class="comment-copy">Unfortunately I never found a solution to this problem, and I know the developer who inherited it ran into the problem a year or so later. Check your P3P headers and good luck!</span></text><author><a class="comment-user owner" href="/users/867633/jaik-dean" title="444 reputation">Jaik Dean</a></author></comment></comments></answer><answer><text><div class="post-text" itemprop="text">
<p>Check your Internet Options in IE11.
Tools &gt; Internet Options &gt; Privacy &gt; Advanced</p>
<p>Maybe you should override that and enable "Always allow session cookies".</p>
</div></text><author><a href="/users/1784001/otisonoza">otisonoza</a></author><comments/></answer></answers></post>