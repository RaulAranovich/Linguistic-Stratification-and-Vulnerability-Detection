<?xml version="1.0" encoding="utf-8"?>
<post><title>php - How to fake $_SERVER['REMOTE_ADDR'] variable? - Stack Overflow</title><question><text><div class="post-text" itemprop="text">
<p>Is it possible to fake or hijack a content of <code>$_SERVER['REMOTE_ADDR']</code> variable?</p>
<p>I would like to fake a request with:</p>
<pre class="lang-php prettyprint prettyprinted" style=""><code><span class="pln">$_SERVER</span><span class="pun">[</span><span class="str">'REMOTE_ADDR'</span><span class="pun">]=</span><span class="str">'127.0.0.1'</span><span class="pun">;</span></code></pre>
<p>How could I do that with PHP? Can CURL do that somehow?</p>
</div></text><author><a href="/users/1640606/samayo">samayo</a></author><comments/></question><answers><answer><text><div class="post-text" itemprop="text">
<p>I assume that you mean faking it remotely.  The short answer is yes you can.  The long answer about how easy it is depends on how you want to fake it.</p>
<p>If you don't care about receiving a response, it's as trivial as opening a raw socket to the destination and forging the source IP address.  I'm not sure if it's really easy to do in PHP since all of PHP's socket implementations are at or above the TCP level.  But I'm sure it's possible.  Now, since you're not in control of the network, the response will not go back to you.  So that means that you cannot (reliably anyway) create a TCP connection via a trivial forged TCP header (since the syn-ack does prevent this by requiring two-way communication).</p>
<p>However, if you can compromise the gateway the IP is off of, you can do whatever you'd like.  So if you compromise the wifi router a computer is connected to, you can pretend to be that computer, and the server won't tell the difference.  If you compromise the ISP's outbound router, you can (in theory at least) pretend to be the computer and the server won't tell the difference.</p>
<p>For some more info, see these following links:</p>
<ul>
<li><a href="https://serverfault.com/questions/90725/are-ip-addresses-trivial-to-forge">ServerFault Question</a></li>
<li><a href="http://www.symantec.com/connect/articles/ip-spoofing-introduction" rel="nofollow noreferrer">Symantec Article</a></li>
<li><a href="http://www.linuxsecurity.com/resource_files/documentation/tcpip-security.html" rel="nofollow noreferrer">Linux Security Article</a></li>
</ul>
<p>However, you will only be able to forge the <code>127.0.0.1</code> loopback address under TCP if you actually compromise the local machine/server.  And at that point does it really matter?</p>
<h2>Important</h2>
<p>If you're using a framework to access this information, be <strong>absolutely sure</strong> that it does not check the <code>X-HTTP-FORWARDED-FOR</code> header!  Otherwise it's trivial to fake the IP address.  For example, if you're using <a href="http://framework.zend.com/apidoc/1.11/Zend_Controller/Request/Zend_Controller_Request_Http.html#getClientIp" rel="nofollow noreferrer">Zend Framework's <code>Zend_Controller_Request_Http::getClientIp</code></a> method, be absolutely sure that you pass <code>false</code> as the parameter!  Otherwise someone just needs to send an HTTP header: <code>X-Http-Forwarded-For: 127.0.0.1</code> and they now appear to be local!  This is one case where using a framework without understanding how it works in the backend can really be bad...</p>
<h2>Edit: Relevant</h2>
<p>I wrote a blog post recently about how I stumbled across a vulnerability in StackOverflow's application. It's very relevant here, since it exploits a very similar mechanism to what this question is looking for (although the circumstances around it are somewhat narrow):</p>
<p><a href="http://blog.ircmaxell.com/2012/11/anatomy-of-attack-how-i-hacked.html" rel="nofollow noreferrer">How I Hacked StackOverflow</a></p>
</div></text><author><a href="/users/338665/ircmaxell">ircmaxell</a></author><comments><comment><text><span class="comment-copy">+ this is rich .....</span></text><author><a class="comment-user" href="/users/1226894/baba" title="69,009 reputation">Baba</a></author></comment></comments></answer><answer><text><div class="post-text" itemprop="text">
<p>The remote address is not something added out of courtesy, it's used in the IP protocol to route packages, so if you <a href="http://en.wikipedia.org/wiki/IP_address_spoofing" rel="noreferrer">send a package with a fake address</a>, you will not receive a response, and since you're talking about a HTTP request, which is delivered over a TCP connection, which takes several IP packets (and the matching responses) to set up:</p>
<p>No, that's impossible (except of course by actually sending the request from the same host via the loopback interface). </p>
</div></text><author><a href="/users/16883/michael-borgwardt">Michael Borgwardt</a></author><comments><comment><text><span class="comment-copy">Furthermore, it looks like something that'd need some tweaking in your TCP stack and network card driver.</span></text><author><a class="comment-user" href="/users/13508/%c3%81lvaro-gonz%c3%a1lez" title="88,106 reputation">Álvaro González</a></author></comment></comments></answer><answer><text><div class="post-text" itemprop="text">
<p>Apache populates <code>$_SERVER['REMOTE_ADDR']</code>  from a TCP socket that it uses to communicate with your browser.  It is <strong>IMPOSSIBLE</strong> to influence this variable over the open internet because of the <a href="http://www.inetdaemon.com/tutorials/internet/tcp/3-way_handshake.shtml" rel="noreferrer">three-way-handshake</a>.   If the client and the server is on a broadcast network,  like wifi, then you can sniff the wire and complete the handshake. </p>
</div></text><author><a href="/users/183528/rook">rook</a></author><comments/></answer><answer><text><div class="post-text" itemprop="text">
<p>You can overwrite any item in the <code>$_SERVER</code> array, including the one you mention, in <em>your</em> server; of course, not in someone else's.</p>
<p>However, it won't change your computer's IP address.</p>
</div></text><author><a href="/users/13508/%c3%81lvaro-gonz%c3%a1lez">Álvaro González</a></author><comments/></answer><answer><text><div class="post-text" itemprop="text">
<p>If you browse via a proxy, <code>$_SERVER['REMOTE_ADDR']</code> may be set to the proxy's IP address rather than the end user's.</p>
<p>There are other headers which you can use instead in this case: This page gives a function which checks all the possibilities and provides the address most likely to be the end user's:</p>
<p><a href="http://roshanbh.com.np/2007/12/getting-real-ip-address-in-php.html" rel="noreferrer">http://roshanbh.com.np/2007/12/getting-real-ip-address-in-php.html</a></p>
<p>However if the user is proxying using a badly configured proxy, or a malicious one, or one designed to anonymise the end user, then you won't be able to guarantee any of the headers other than <code>REMOTE_ADDR</code> (which would only lead you as far as the proxy).</p>
<p>If your end user is browsing via HTTPS, then <code>REMOTE_ADDR</code> will always be his IP address; you can't use proxy forwarding via HTTPS. Therefore, the one way to be absolutely sure of his address is to get him to open your site in HTTPS.</p>
</div></text><author><a href="/users/352765/spudley">Spudley</a></author><comments><comment><text><span class="comment-copy">Is this still a reliable solution 5 years on?</span></text><author><a class="comment-user" href="/users/1090438/jonathan" title="3,319 reputation">Jonathan</a></author></comment></comments></answer><answer><text><div class="post-text" itemprop="text">
<p><code>REMOTE_ADDR</code></p>
<blockquote>
<p>The IP address from which the user is viewing the current page.</p>
</blockquote>
<p>You can request script using proxy, etc. to change IP address but you cannot set there any text you want.</p>
</div></text><author><a href="/users/223386/hsz">hsz</a></author><comments/></answer><answer><text><div class="post-text" itemprop="text">
<p>That is a variable set by apache or whatever server you're using. You cannot spoof it. 
You may run <code>$_SERVER['REMOTE_ADDR']='127.0.0.1';</code> at the beginning of the scripts, but i doubt thats what you're trying to do</p>
</div></text><author><a href="/users/11301/quamis">Quamis</a></author><comments/></answer></answers></post>