<?xml version="1.0" encoding="utf-8"?>
<post><title>javascript - Angular changes urls to "unsafe:" in extension page - Stack Overflow</title><question><text><div class="post-text" itemprop="text">
<p>I am trying to use angular with a list of apps, and each one is a link to see an app in more detail (apps/app.id):</p>
<pre class="default prettyprint prettyprinted" style=""><code><span class="tag">&lt;a</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"{{app.id}}"</span><span class="pln"> </span><span class="atn">href</span><span class="pun">=</span><span class="atv">"apps/{{app.id}}"</span><span class="pln"> </span><span class="tag">&gt;</span><span class="pln">{{app.name}}</span><span class="tag">&lt;/a&gt;</span></code></pre>
<p>Every time I click on one of these links, Chrome shows the URL as unsafe:chrome-extension://kpbipnfncdpgejhmdneaagc...../apps/app.id</p>
<p>Where does the <strong>unsafe</strong> come from?</p>
</div></text><author><a href="/users/283863/derek-%e6%9c%95%e6%9c%83%e5%8a%9f%e5%a4%ab">Derek 朕會功夫</a></author><comments><comment><text><span class="comment-copy">Keep in mind that you should use <code>ng-href</code> in this case rather than just <code>href</code>: <a href="https://docs.angularjs.org/api/ng/directive/ngHref" rel="nofollow noreferrer">docs.angularjs.org/api/ng/directive/ngHref</a></span></text><author><a class="comment-user" href="/users/1556870/hartz89" title="358 reputation">hartz89</a></author></comment></comments></question><answers><answer><text><div class="post-text" itemprop="text">
<p>You need to explicitly add URL protocols to Angular's whitelist using a regular expression. Only <code>http</code>, <code>https</code>, <code>ftp</code> and <code>mailto</code> are enabled by default. Angular will prefix a non-whitelisted URL with <code>unsafe:</code> when using a protocol such as <code>chrome-extension:</code>.</p>
<p>A good place to whitelist the <code>chrome-extension:</code> protocol would be in your module's config block:</p>
<pre class="default prettyprint prettyprinted" style=""><code><span class="kwd">var</span><span class="pln"> app </span><span class="pun">=</span><span class="pln"> angular</span><span class="pun">.</span><span class="kwd">module</span><span class="pun">(</span><span class="pln"> </span><span class="str">'myApp'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[]</span><span class="pln"> </span><span class="pun">)</span><span class="pln">
</span><span class="pun">.</span><span class="pln">config</span><span class="pun">(</span><span class="pln"> </span><span class="pun">[</span><span class="pln">
    </span><span class="str">'$compileProvider'</span><span class="pun">,</span><span class="pln">
    </span><span class="kwd">function</span><span class="pun">(</span><span class="pln"> $compileProvider </span><span class="pun">)</span><span class="pln">
    </span><span class="pun">{</span><span class="pln">   
        $compileProvider</span><span class="pun">.</span><span class="pln">aHrefSanitizationWhitelist</span><span class="pun">(</span><span class="str">/^\s*(https?|ftp|mailto|chrome-extension):/</span><span class="pun">);</span><span class="pln">
        </span><span class="com">// Angular before v1.2 uses $compileProvider.urlSanitizationWhitelist(...)</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
</span><span class="pun">]);</span></code></pre>
<p>The same procedure also applies when you need to use protocols such as <code>file:</code> and <code>tel:</code>.</p>
<p>Please see the AngularJS <a href="http://docs.angularjs.org/api/ng.$compileProvider" rel="noreferrer">$compileProvider API documentation</a> for more info.</p>
</div></text><author><a href="/users/619602/philip-bulley">Philip Bulley</a></author><comments><comment><text><span class="comment-copy">In Angular 1.2 the method name became <code>$compileProvider.aHrefSanitizationWhitelist</code></span></text><author><a class="comment-user" href="/users/183386/mart" title="3,675 reputation">Mart</a></author></comment><comment><text><span class="comment-copy">Default imgSrcSanitizationWhitelist Angular 1.2-rc2 is <code>/^\s*(https?|ftp|file):|data:image\//</code>, to access the local filesystem for a chrome packaged app <code>|filesystem:chrome-extension:</code> should be added to the end of the regex.</span></text><author><a class="comment-user" href="/users/2076536/henning" title="126 reputation">Henning</a></author></comment><comment><text><span class="comment-copy">Note that in Angular 1.2, there are actually two methods -- One for links (aHrefSanitizationWhitelist) and one for images (imgSrcSanitizationWhitelist). This had me stuck for a while.</span></text><author><a class="comment-user" href="/users/1250418/mdierker" title="362 reputation">mdierker</a></author></comment><comment><text><span class="comment-copy">For a Chrome Packaged App you'll need to add <code>|blob:chrome-extension:</code> to the end.</span></text><author><a class="comment-user" href="/users/610982/adam8810" title="402 reputation">adam8810</a></author></comment><comment><text><span class="comment-copy">Note that this does not work for images, for images look at this other question: <a href="http://stackoverflow.com/a/22798336/1277693">stackoverflow.com/a/22798336/1277693</a></span></text><author><a class="comment-user" href="/users/1277693/papirrin" title="853 reputation">papirrin</a></author></comment><comment><text><span class="comment-copy">Note the file protocol is different from the blob protocol:     <code>$compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|fil‌​e|blob|ftp|mailto|ch‌​rome-extension):/);</code></span></text><author><a class="comment-user" href="/users/2878281/arnaud-leyder" title="3,689 reputation">Arnaud Leyder</a></author></comment><comment><text><span class="comment-copy">I think the author forgot to escape the <code>-</code> character in <code>chrome-extension</code>. The regexp should be something like /^\s*(https?|ftp|mailto|chrome\-extension):/</span></text><author><a class="comment-user" href="/users/289912/vladius" title="478 reputation">Vladius</a></author></comment><comment><text><span class="comment-copy">@Vladius, afaik the <code>-</code> char would only need escaping if it were to appear within a character set <code>[]</code>, in which case an unescaped <code>-</code> would represent a range. The unescaped <code>-</code> should be fine in this scenario.</span></text><author><a class="comment-user" href="/users/619602/philip-bulley" title="5,080 reputation">Philip Bulley</a></author></comment></comments></answer><answer><text><div class="post-text" itemprop="text">
<p>In case anyone has this problem with images, as well:</p>
<pre class="default prettyprint prettyprinted" style=""><code><span class="pln">app</span><span class="pun">.</span><span class="pln">config</span><span class="pun">([</span><span class="str">'$compileProvider'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$compileProvider</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    $compileProvider</span><span class="pun">.</span><span class="pln">imgSrcSanitizationWhitelist</span><span class="pun">(</span><span class="str">/^\s*(https?|local|data|chrome-extension):/</span><span class="pun">);</span><span class="pln">
</span><span class="pun">}]);</span></code></pre>
</div></text><author><a href="/users/4230970/r-salisbury">R. Salisbury</a></author><comments><comment><text><span class="comment-copy">I tried using the regular expression for white listing the image screen shots i am capturing with html2canvas , now there is no error that says unsafe:data; but the image is not getting captured. Any idea what regular expression i shall use ? I am capturing a image/png as base64 url. Now the html looks like : &lt;img ng-src="data:," class="img-responsive" src="data:,"&gt; instead of the actual base64 url</span></text><author><a class="comment-user" href="/users/2609095/srini" title="498 reputation">Srini</a></author></comment></comments></answer><answer><text><div class="post-text" itemprop="text">
<p>Google Chrome require its extensions to cooperate with <code>Content Security Policy (CSP)</code>.</p>
<p>You need to modify your extension to fulfill the requirements of <code>CSP</code>.</p>
<p><a href="https://developer.chrome.com/extensions/contentSecurityPolicy.html" rel="nofollow">https://developer.chrome.com/extensions/contentSecurityPolicy.html</a></p>
<p><a href="https://developer.mozilla.org/en-US/docs/Security/CSP" rel="nofollow">https://developer.mozilla.org/en-US/docs/Security/CSP</a></p>
<p>Also, angularJS has <code>ngCsp</code> directive which you need to use.</p>
<p><a href="http://docs.angularjs.org/api/ng.directive:ngCsp" rel="nofollow">http://docs.angularjs.org/api/ng.directive:ngCsp</a></p>
</div></text><author><a href="/users/825780/umur-kontac%c4%b1">Umur Kontacı</a></author><comments><comment><text><span class="comment-copy">I already have the ngCsp directive for that page '&lt;html ng-app="myApp" ng-csp&gt;'. This is the CSP from my manifest: <code>"content_security_policy": "script-src 'self' https://ssl.google-analytics.com; object-src 'self'",</code>  Do I need to change the csp in the manifest?</span></text><author><a class="comment-user owner" href="/users/1781631/ebi" title="1,955 reputation">ebi</a></author></comment></comments></answer><answer><text><div class="post-text" itemprop="text">
<p>If you just need for mail, tel and sms use this:</p>
<pre class="default prettyprint prettyprinted" style=""><code><span class="pln">app</span><span class="pun">.</span><span class="pln">config</span><span class="pun">([</span><span class="str">'$compileProvider'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$compileProvider</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    $compileProvider</span><span class="pun">.</span><span class="pln">aHrefSanitizationWhitelist</span><span class="pun">(</span><span class="str">/^\s*(https?|ftp|mailto|file|sms|tel):/</span><span class="pun">);</span><span class="pln">
</span><span class="pun">}]);</span></code></pre>
</div></text><author><a href="/users/7574925/ivasyliv">Ivasyliv</a></author><comments/></answer></answers></post>