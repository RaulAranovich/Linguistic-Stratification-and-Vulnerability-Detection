<?xml version="1.0" encoding="utf-8"?>
<post><title>security - How To Become a SAML Service Provider - Stack Overflow</title><question><text><div class="post-text" itemprop="text">
<p>Morning Everyone,</p>
<p>My company currently develops a Java web application. A couple of our clients have internal SAML servers (identity providers?) and have request that we integrate with them. So recently I've been reading up on it and playing around with OpenAM. After about 3 days of this I have a general understanding of it, but there are still some gaps in my knowledge. My hope is that someone can clear this up for me.</p>
<p>So here's how I imagine the workflow of a user logging in. Let's define our customers SAML server as <a href="https://their.samlserver.com">https://their.samlserver.com</a>. So a user comes to our web application for a resource that's protected. Let's say that URL is <a href="http://my.app.com/something">http://my.app.com/something</a>. So if I'm correct, "my.app.com" is what SAML defines as a "Service Provider". Our application realizes that this user needs to log in. We then present a page like this to the user...</p>
<pre><code>&lt;script&gt;JQuery Script to auto submit this form on ready&lt;/script&gt;
&lt;form method="post" action="https://their.samlserver.com/Post/Servlet"&gt;
    &lt;input type="hidden" name="SAMLRequest" value="someBase64Data" /&gt;
    &lt;input type="submit" value="Submit" /&gt;
&lt;/form&gt;
</code></pre>
<p>And that someBase64Data should be base64 encoded version of this...</p>
<pre><code>&lt;samlp:AuthnRequest
  xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol"
  xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion"
  ID="identifier_1"
  Version="2.0"
  IssueInstant="2004-12-05T09:21:59Z"
  AssertionConsumerServiceIndex="0"&gt;
 &lt;saml:Issuer&gt;http://my.app.com&lt;/saml:Issuer&gt;
 &lt;samlp:NameIDPolicy
   AllowCreate="true"
   Format="urn:oasis:names:tc:SAML:2.0:nameid-format:transient"/&gt;
&lt;/samlp:AuthnRequest&gt;
</code></pre>
<p>So my first couple questions. What is the "ID" value suppose to be? And why can I declare myself as an "Issuer"? Does the Identity Provider know about me? Maybe this is that "Circle of trust" I've been seeing on OpenAM. And if it does know about me, how does it know about me and what does it need to know?</p>
<p>So after the user is forwarded that page, they are taken to a page provided by the IDP <a href="https://their.samlserver.com">https://their.samlserver.com</a>. They authenticate on that page and the IDP does it's magic to validate the authentication and look up the user. After the authentication is successful, the IDP sends back a <code>&lt;samlp:Response&gt;</code> defined <a href="http://en.wikipedia.org/wiki/SAML_2.0">here</a>.</p>
<p>A few more questions. First, how does the <code>&lt;samlp:Response&gt;</code> get back to my web application so I can check it? And what should I be looking for in that response to validate that it was successful? What does a failure look like?</p>
<p>We currently use email address (LDAP) to identify users, so we'll probably grab that from the response and use that in the same way we do now. Anything else I should be mindful of in that response?</p>
<p>So now that we've checked that response for validity, we can grant the user a session like we do currently. But when they want to log out, is there a workflow for that? Do I have to notify the IDP that the user has left?</p>
<p>And finally, there are a couple of topics that have been thrown around in my reading and I'm not sure how they fit into this workflow. They are "Circle of trust", "Tokens", and "Artifacts".</p>
<p>Thanks for any help everyone. I've found a lot of information in the last couple days, and it's possible that I could piece them together after a bit more playing. But I have yet to find a straight forward "Here's the Post" workflow article yet. Maybe that's because I'm wrong on how this works. Maybe it's because this isn't that popular yet. But I really wanted to make sure that I got the workflow so I didn't miss a crucial step in something as important as user authentication.</p>
</div></text><author><a href="/users/256828/staros">Staros</a></author><comments><comment><text><span class="comment-copy">I'm going through the same problem right now (looking into how to create a lightweight federated SAML v2 service provider interacting with Ping Identity). Do you mind commenting how it worked out for you? Did you end up using a fedlet or writing your own code? Thanks!</span></text><author><a class="comment-user" href="/users/1118101/theglauber" title="11,562 reputation">theglauber</a></author></comment><comment><text><span class="comment-copy">I am having somewhat similar environment. I have a java based web application running on tomcat now I have to do SSO using SAML. I have no idea about these technologies other than the theoretical knowledge. Can anybody help me in configuring from scratch?</span></text><author><a class="comment-user" href="/users/3778710/jerry" title="155 reputation">Jerry</a></author></comment></comments></question><answers><answer><text><div class="post-text" itemprop="text">
<p>In response to your specific questions:</p>
<p>1.) What is the "ID" value supposed to be?</p>
<ul>
<li>This should be a unique identifier for the SAML request.  The SAML 2.0 specification states that it's really implementation specific how this is done, but makes the following recommendations:
"The mechanism by which a SAML system entity ensures that the identifier is unique is left to the implementation. In the case that a random or pseudorandom technique is employed, the probability of two randomly chosen identifiers being identical MUST be less than or equal to 2 ^ -128 and SHOULD be less than or equal to 2 ^-160 in length.  This requirement MAY be met by encoding a randomly chosen value between 128 and 160 bits in length."</li>
</ul>
<p>2.) How does the IdP know about you?</p>
<ul>
<li>Your SP needs to be registered with the IdP.  To accomplish this, the SAML specification defines a format for "SAML Metadata" which tells the IdP where your SAML receivers are, what your certificates are, attributes you exchange, etc.  OpenAM likely dictates some minimum requirements for configuring a trusted SP.  This varies in each product.</li>
</ul>
<p>3.) Where's the Response go, and what to check?</p>
<ul>
<li>The Response will go to your Assertion Consumer Service URL usually defined in the SAML Metadata you exchange from your SP with the IdP for initial setup.  When you receive a SAML Response, you need to check many things - but most importantly, the SAML Status code should be "success", the inResponseTo ID's should match the request's sent ones and you must validate the digital signature on the Assertion.  For that, you'll need to trust the IdP's public verification certificate, and you'll probably also want to do revocation checking.</li>
</ul>
<p>4.) What about Logout?</p>
<ul>
<li>SAML 2.0 also defines a profile for Single LogOut (SLO).  This will not only log you out of the SP, but also the IdP and potentially any other SP's you've established a sesssion with.  It has a similar request/response flow as Single Sign On (SSO), and thus similar things to setup and check (status codes, signatures, etc.).</li>
</ul>
<p>So in short - this can be quite complex to implement from scratch.  It's best to use tried &amp; true libraries and/or products like Ian suggests.  Companies like his have invested hundreds of hours of developer time to implement according to the spec and test interoperability with other vendors.</p>
</div></text><author><a href="/users/636982/scott-t">Scott T.</a></author><comments><comment><text><span class="comment-copy">Why should there be an ID in the saml request. I don't get that.</span></text><author><a class="comment-user" href="/users/1139023/ashwin" title="3,317 reputation">Ashwin</a></author></comment><comment><text><span class="comment-copy">It's required as part of the SAML 2.0 core spec.  See <a href="http://docs.oasis-open.org/security/saml/v2.0/saml-core-2.0-os.pdf" rel="nofollow noreferrer">docs.oasis-open.org/security/saml/v2.0/saml-core-2.0-os.pdf</a>. AuthnRequest is of type AuthnRequestType (section 3.4.1) which is an extension of the RequestAbstractType (section 3.2.1) which has a mandatory ID attribute.  One of the key benefits to the ID in the request is so the Response can then reference it so the SP can map the two together to prevent replay.</span></text><author><a class="comment-user" href="/users/636982/scott-t" title="4,028 reputation">Scott T.</a></author></comment><comment><text><span class="comment-copy">You say id is given to prevent replay attack. If I am using a ssl/https connection betwen the Service Provider and the IDProvider, can replay attack be prevented.</span></text><author><a class="comment-user" href="/users/1139023/ashwin" title="3,317 reputation">Ashwin</a></author></comment><comment><text><span class="comment-copy">SSL/HTTPS between SP and IdP is somewhat meaningless to prevent replay attack, since "front channel" (browser) bindings are typically used.</span></text><author><a class="comment-user" href="/users/636982/scott-t" title="4,028 reputation">Scott T.</a></author></comment><comment><text><span class="comment-copy">@Ashwin - The id is there so that when you get the response back it has that same id and you can know that the response you're receiving was in relation to your request, as far as preventing replay, my understanding is that there are a lot of timestamps in both the requests and reponses in SAML and id's are only viable along with authorization for limited periods of time.</span></text><author><a class="comment-user" href="/users/477494/uncle-iroh" title="2,139 reputation">Uncle Iroh</a></author></comment></comments></answer><answer><text><div class="post-text" itemprop="text">
<p>Ping Identity a pretty extensive list of Service Providers using its software to provide SAML1.x/2.0 &amp; WS-Federation SSO capabilities to their customers. <a href="http://www.pingidentity.com/partners/partnerdirectory.cfm" rel="nofollow">Here's a link</a> where you can view a portion of our Partners to date. Ping also has created the only (AFAIK) SAML-as-a-Service offering for SaaS Apps (<a href="https://www.pingidentity.com/en/products/pingone/sign-up-saas.html" rel="nofollow">https://www.pingidentity.com/en/products/pingone/sign-up-saas.html</a>)). </p>
<p>However, regarding information flow details, if you check out the <a href="http://documentation.pingidentity.com/display/PF72/Browser-based+SSO" rel="nofollow">Getting Started Guide</a> it has a whole section on Web SSO standards they support and flow details for each (for example, SP-Init SSO POST/POST). That will probably have some of the info you are looking for. Also, the SAML spec itself has quite a bit of detail in the <a href="http://www.oasis-open.org/committees/download.php/27819/sstc-saml-tech-overview-2.0-cd-02.pdf" rel="nofollow">SAML 2.0 Technical Overview</a> document that OASIS produced.</p>
<p>Hope this helps -
Ian</p>
</div></text><author><a href="/users/368372/ian">Ian</a></author><comments/></answer><answer><text><div class="post-text" itemprop="text">
<p>If you're just trying to set a single Java application up as a Service Provider, you should consider using a Fedlet from either <a href="http://www.oracle.com/technetwork/middleware/downloads/oid-11g-161194.html" rel="nofollow" title="Oracle">Oracle</a> (as a standalone ) or <a href="http://www.forgerock.org/downloads/openam/snapshot9.5/openam_snapshot_952.zip" rel="nofollow" title="ForgeRock">ForgeRock</a> ( bundled with OpenAM ).  The ForgeRock Fedlet has some issues interacting with Shibboleth 2.2.1 as an Identity Provider, but I find it to be somewhat simpler to configure and more informative.</p>
<p>Each has explicit instructions contained in the README to help you deploy.  Once the Fedlet is configured and communicating with the IDP, the success page shows you all the code you need to integrate federated SSO into your application.  It does the background work of sending and receiving AuthnRequests and Responses.</p>
<p>Scott's answer responds quite well to the questions you had, but I think that trying to write code on your own that generates the SAML is reinventing the wheel.  The Fedlet was designed with precisely this use case in mind.</p>
</div></text><author><a href="/users/538917/user538917">user538917</a></author><comments/></answer></answers></post>